generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Negocio {
  id           String    @id @default(uuid())
  nombre       String    @unique
  createdAt    DateTime  @default(now())

  limitTime    DateTime
  userlimit    Int
  locallimit   Int
  productlimit Int       @default(0) // L칤mite de productos por plan

  usuarios   Usuario[]
  tiendas    Tienda[]
  categorias Categoria[]
  productos  Producto[]
}

// Representa un local. Puede tener m칰ltiples usuarios y productos asociados.
model Tienda {
  id              String            @id @default(uuid())
  nombre          String            // Removido @unique - ahora ser치 칰nico por negocio
  usuarios        UsuarioTienda[] // Relaci칩n con la tabla intermedia UsuarioTienda
  productos       ProductoTienda[] // Relaci칩n con los productos que vende el local
  ventas          Venta[] // Relaci칩n con las ventas realizadas en el local
  cierres         CierrePeriodo[]
  tipo            String            @default("tienda")
  MovimientoStock MovimientoStock[]

  negocio         Negocio          @relation(fields: [negocioId], references: [id])
  negocioId       String              @default("")

  usuario         Usuario[]

  // 칈ndice de unicidad compuesto: nombre 칰nico por negocio
  @@unique([nombre, negocioId])
}

// Representa un usuario que puede estar vinculado a m칰ltiples tiendas.
model Usuario {
  id              String            @id @default(uuid())
  nombre          String
  usuario         String            @unique // Nombre de usuario 칰nico
  password        String
  rol             String            @default("vendedor") // Rol del usuario en el sistema

  tiendas         UsuarioTienda[] // Relaci칩n con la tabla intermedia UsuarioTienda
  ventas          Venta[] // Un usuario puede realizar m칰ltiples ventas
  MovimientoStock MovimientoStock[]

  negocio         Negocio           @relation(fields: [negocioId], references: [id])
  negocioId       String             @default("")

  tiendaActual    Tienda?            @relation(fields: [tiendaActualId], references: [id])
  tiendaActualId     String?
}

// Tabla intermedia para manejar la relaci칩n muchos a muchos entre Usuario y Tienda.
model UsuarioTienda {
  id        String  @id @default(uuid())
  usuario   Usuario @relation(fields: [usuarioId], references: [id]) // Usuario asociado
  usuarioId String
  tienda    Tienda  @relation(fields: [tiendaId], references: [id]) // Tienda asociada
  tiendaId  String

  @@unique([usuarioId, tiendaId]) // Garantiza que un usuario no se duplique en una tienda
}

// Representa una categor칤a de productos (ej. Electr칩nica, Ropa, etc.)
model Categoria {
  id        String     @id @default(uuid())
  nombre    String     // Removido @unique - ahora ser치 칰nico por negocio
  color     String // Color representativo (hexadecimal)
  productos Producto[] // Relaci칩n con los productos de esta categor칤a

  negocio   Negocio   @relation(fields: [negocioId], references: [id])
  negocioId String       @default("")

  // 칈ndice de unicidad compuesto: nombre 칰nico por negocio
  @@unique([nombre, negocioId])
}

// Representa un producto gen칠rico, sin relaci칩n con tiendas espec칤ficas.
model Producto {
  id              String           @id @default(uuid())
  nombre          String           // Removido @unique - ahora ser치 칰nico por negocio
  descripcion     String
  categoria       Categoria        @relation(fields: [categoriaId], references: [id]) // Categor칤a a la que pertenece
  categoriaId     String
  productosTienda ProductoTienda[] // Relaci칩n con las tiendas donde se vende
  
  // 游댕 Fracci칩n: Este producto es una fracci칩n de otro (ej: Cigarro Suelto -> Caja de Cigarro)
  fraccionDe       Producto?       @relation("ProductoFraccion", fields: [fraccionDeId], references: [id])
  fraccionDeId     String?         // ID del producto padre (opcional)
  fracciones       Producto[]      @relation("ProductoFraccion") // Productos que se derivan de este

  unidadesPorFraccion Int?         // Cu치ntas unidades se generan al fraccionar 1 del producto padre

  negocio         Negocio          @relation(fields: [negocioId], references: [id])
  negocioId       String            @default("")

  // 칈ndice de unicidad compuesto: nombre 칰nico por negocio
  @@unique([nombre, negocioId])
}

// Tabla intermedia para manejar la relaci칩n muchos a muchos entre Producto y Tienda.
model ProductoTienda {
  id          String            @id @default(uuid())
  tienda      Tienda            @relation(fields: [tiendaId], references: [id]) // Tienda donde se vende el producto
  tiendaId    String
  producto    Producto          @relation(fields: [productoId], references: [id]) // Producto asociado
  productoId  String
  costo       Float             @default(0) // Costo del producto en esa tienda
  precio      Float             @default(0) // Precio de venta en esa tienda espec칤fica
  existencia  Int               @default(0)   // Cantidad en stock en esa tienda
  ventas      VentaProducto[] // Relaci칩n con la tabla intermedia de ventas
  movimientos MovimientoStock[] // Relacion con la tabla de movimientos

  @@unique([tiendaId, productoId]) // Agrega esta l칤nea
}

// Representa una venta realizada en una tienda.
model Venta {
  id            String          @id @default(uuid())
  createdAt     DateTime        @default(now()) // Fecha de creaci칩n
  productos     VentaProducto[] // Productos vendidos en esta venta
  total         Float // Monto total de la venta
  totalcash     Float // Monto total en efectivo
  totaltransfer Float // Monto en transferencia
  tienda        Tienda          @relation(fields: [tiendaId], references: [id]) // Tienda donde se realiz칩 la venta
  tiendaId      String
  usuario       Usuario         @relation(fields: [usuarioId], references: [id])
  usuarioId     String
  syncId        String?         @default(uuid()) // Id generado en el front para evitar repetir ventas por fallos de sincronizaci칩n          

  cierrePeriodo   CierrePeriodo? @relation(fields: [cierrePeriodoId], references: [id])
  cierrePeriodoId String?
}

// Tabla intermedia para manejar la relaci칩n muchos a muchos entre Venta y ProductoTienda.
model VentaProducto {
  id               String         @id @default(uuid())
  venta            Venta          @relation(fields: [ventaId], references: [id]) // Venta asociada
  ventaId          String
  producto         ProductoTienda @relation(fields: [productoTiendaId], references: [id]) // Producto vendido
  productoTiendaId String
  cantidad         Int // Cantidad de productos vendidos en la transacci칩n
}

// Representa un per칤odo de ventas cerrado con una fecha de inicio y una fecha de cierre.
model CierrePeriodo {
  id          String    @id @default(uuid())
  fechaInicio DateTime
  fechaFin    DateTime?
  tienda      Tienda    @relation(fields: [tiendaId], references: [id])
  tiendaId    String
  ventas      Venta[]

  // Campos denormalizados para resumen
  totalVentas         Float @default(0)
  totalGanancia       Float @default(0)
  totalInversion      Float @default(0)
  totalTransferencia  Float @default(0)

  // Idices
  @@index([fechaInicio])
  @@index([fechaFin])
  @@index([tiendaId])
}

model MovimientoStock {
  id               String         @id @default(uuid())
  productoTienda   ProductoTienda @relation(fields: [productoTiendaId], references: [id])
  productoTiendaId String

  tipo         MovimientoTipo // "ENTRADA" | "SALIDA" | "AJUSTE" | "VENTA"
  cantidad     Int // Positiva para entradas, negativa para salidas
  motivo       String? // Texto libre o tipos definidos (ajuste manual, error, etc.)
  referenciaId String? // Puede guardar el ID de una Venta, Entrada o Ajuste
  fecha        DateTime       @default(now())
  
  // Existencia del producto ANTES de aplicar este movimiento
  existenciaAnterior Int? // Null para movimientos existentes, valor para nuevos movimientos

  usuario   Usuario? @relation(fields: [usuarioId], references: [id])
  usuarioId String?

  tienda   Tienda @relation(fields: [tiendaId], references: [id])
  tiendaId String

  @@index([productoTiendaId])
  @@index([fecha])
}

enum MovimientoTipo {
  COMPRA
  VENTA
  TRASPASO_ENTRADA
  TRASPASO_SALIDA
  AJUSTE_SALIDA
  AJUSTE_ENTRADA
  DESAGREGACION_BAJA
  DESAGREGACION_ALTA
}
