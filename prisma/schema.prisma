generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Negocio {
  id          String   @id @default(uuid())
  nombre      String   @unique
  descripcion String?
  createdAt   DateTime @default(now())

  limitTime    DateTime
  userlimit    Int
  locallimit   Int
  productlimit Int      @default(0) // L铆mite de productos por plan

  usuarios    Usuario[]
  tiendas     Tienda[]
  categorias  Categoria[]
  productos   Producto[]
  proveedores Proveedor[]
  roles       Rol[]
  suspended   Boolean     @default(false)
  suspendedAt DateTime?

  // Relaci贸n inversa para reglas de descuento
  discountRules DiscountRule[]
}

// Representa un local. Puede tener m煤ltiples usuarios y productos asociados.
model Tienda {
  id        String           @id @default(uuid())
  nombre    String // Removido @unique - ahora ser谩 煤nico por negocio
  usuarios  UsuarioTienda[] // Relaci贸n con la tabla intermedia UsuarioTienda
  productos ProductoTienda[] // Relaci贸n con los productos que vende el local
  ventas    Venta[] // Relaci贸n con las ventas realizadas en el local
  cierres   CierrePeriodo[]
  tipo      String           @default("tienda")

  // Relaciones inversas para MovimientoStock con nombres espec铆ficos
  movimientosOrigen  MovimientoStock[] @relation("MovimientoStockOrigen")
  movimientosDestino MovimientoStock[] @relation("MovimientoStockDestino")

  // Destinos de transferencia para esta tienda
  transferDestinations TransferDestinations[]

  negocio   Negocio @relation(fields: [negocioId], references: [id])
  negocioId String  @default("")

  usuario Usuario[]

  // ndice de unicidad compuesto: nombre 煤nico por negocio
  @@unique([nombre, negocioId])
}

// Representa un usuario que puede estar vinculado a m煤ltiples tiendas.
model Usuario {
  id       String  @id @default(uuid())
  nombre   String
  usuario  String  @unique // Nombre de usuario 煤nico
  password String
  rol      String? // Aqui solo se registrar谩 si el usuario es superadministrador con el rol SUPER_ADMIN

  //tiendas         UsuarioTienda[] // Relaci贸n con la tabla intermedia UsuarioTienda
  locales         UsuarioTienda[] // Relaci贸n con la tabla intermedia UsuarioTienda
  ventas          Venta[] // Un usuario puede realizar m煤ltiples ventas
  MovimientoStock MovimientoStock[]

  //  Relaci贸n con proveedores asociados
  proveedores Proveedor[] @relation("ProveedorUsuario")

  negocio   Negocio @relation(fields: [negocioId], references: [id])
  negocioId String  @default("")

  //tiendaActual    Tienda?            @relation(fields: [tiendaActualId], references: [id])
  //tiendaActualId     String?

  localActual   Tienda? @relation(fields: [localActualId], references: [id])
  localActualId String?

  isActive Boolean @default(true)
}

// Tabla intermedia para manejar la relaci贸n muchos a muchos entre Usuario y Tienda.
model UsuarioTienda {
  id        String    @id @default(uuid())
  usuario   Usuario   @relation(fields: [usuarioId], references: [id]) // Usuario asociado
  usuarioId String
  tienda    Tienda    @relation(fields: [tiendaId], references: [id]) // Tienda asociada
  tiendaId  String
  rol       Rol?      @relation(fields: [rolId], references: [id]) // Rol del usuario en esta tienda
  rolId     String?
  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  @@unique([usuarioId, tiendaId]) // Garantiza que un usuario no se duplique en una tienda
}

// Representa un rol que puede tener un usuario en una tienda espec铆fica
model Rol {
  id          String   @id @default(uuid())
  nombre      String // Nombre del rol (ej: "Vendedor", "Administrador")
  descripcion String? // Descripci贸n opcional del rol
  permisos    String // String con permisos separados por "|" (ej: "pos.vender|pos.cancelarventa")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  negocio   Negocio @relation(fields: [negocioId], references: [id])
  negocioId String

  // Relaci贸n con las asignaciones usuario-tienda
  usuariosTiendas UsuarioTienda[]

  // ndice de unicidad compuesto: nombre 煤nico por negocio
  @@unique([nombre, negocioId])
  @@index([negocioId])
}

// Representa una categor铆a de productos (ej. Electr贸nica, Ropa, etc.)
model Categoria {
  id        String     @id @default(uuid())
  nombre    String // Removido @unique - ahora ser谩 煤nico por negocio
  color     String // Color representativo (hexadecimal)
  productos Producto[] // Relaci贸n con los productos de esta categor铆a

  negocio   Negocio @relation(fields: [negocioId], references: [id])
  negocioId String  @default("")

  // ndice de unicidad compuesto: nombre 煤nico por negocio
  @@unique([nombre, negocioId])
}

// Representa un producto gen茅rico, sin relaci贸n con tiendas espec铆ficas.
model Producto {
  id                         String                         @id @default(uuid())
  nombre                     String // Removido @unique - ahora ser谩 煤nico por negocio
  descripcion                String
  permiteDecimal             Boolean                        @default(false)
  categoria                  Categoria                      @relation(fields: [categoriaId], references: [id]) // Categor铆a a la que pertenece
  categoriaId                String
  productosTienda            ProductoTienda[] // Relaci贸n con las tiendas donde se vende
  prodProveedoresLiquidacion ProductoProveedorLiquidacion[]

  //  Fracci贸n: Este producto es una fracci贸n de otro (ej: Cigarro Suelto -> Caja de Cigarro)
  fraccionDe   Producto?  @relation("ProductoFraccion", fields: [fraccionDeId], references: [id])
  fraccionDeId String? // ID del producto padre (opcional)
  fracciones   Producto[] @relation("ProductoFraccion") // Productos que se derivan de este

  unidadesPorFraccion Int? // Cu谩ntas unidades se generan al fraccionar 1 del producto padre

  negocio   Negocio @relation(fields: [negocioId], references: [id])
  negocioId String  @default("")

  codigosProducto CodigoProducto[]

  // indice de unicidad compuesto: nombre 煤nico por negocio
  @@unique([nombre, negocioId])
}

model CodigoProducto {
  id         String   @id @default(uuid())
  codigo     String   @unique
  producto   Producto @relation(fields: [productoId], references: [id], onDelete: Cascade)
  productoId String
}

// Tabla intermedia para manejar la relaci贸n muchos a muchos entre Producto y Tienda.
model ProductoTienda {
  id          String            @id @default(uuid())
  tienda      Tienda            @relation(fields: [tiendaId], references: [id]) // Tienda donde se vende el producto
  tiendaId    String
  producto    Producto          @relation(fields: [productoId], references: [id]) // Producto asociado
  productoId  String
  costo       Float             @default(0) // Costo del producto en esa tienda
  precio      Float             @default(0) // Precio de venta en esa tienda espec铆fica
  existencia  Float             @default(0) // Cantidad en stock en esa tienda (soporta decimales)
  ventas      VentaProducto[] // Relaci贸n con la tabla intermedia de ventas
  movimientos MovimientoStock[] // Relacion con la tabla de movimientos

  // Proveedor para productos en consignaci贸n (null para productos propios)
  proveedor   Proveedor? @relation(fields: [proveedorId], references: [id])
  proveedorId String?

  // Llave de unicidad compuesta: un producto por tienda y proveedor
  // Esto permite que el mismo producto tenga diferentes existencias por proveedor
  //@@unique([tiendaId, productoId, proveedorId])
}

// Representa una venta realizada en una tienda.
model Venta {
  id            String          @id @default(uuid())
  createdAt     DateTime        @default(now()) // Fecha de creaci贸n
  productos     VentaProducto[] // Productos vendidos en esta venta
  total         Float // Monto total de la venta
  totalcash     Float // Monto total en efectivo
  totaltransfer Float // Monto en transferencia
  //  Total de descuento aplicado (no negativo). Se mantiene separado para trazabilidad
  discountTotal Float           @default(0)
  tienda        Tienda          @relation(fields: [tiendaId], references: [id]) // Tienda donde se realiz贸 la venta
  tiendaId      String
  usuario       Usuario         @relation(fields: [usuarioId], references: [id])
  usuarioId     String
  syncId        String?         @default(uuid()) // Id generado en el front para evitar repetir ventas por fallos de sincronizaci贸n          

  cierrePeriodo   CierrePeriodo? @relation(fields: [cierrePeriodoId], references: [id])
  cierrePeriodoId String?

  transferDestination   TransferDestinations? @relation(fields: [transferDestinationId], references: [id])
  transferDestinationId String?

  //  NUEVOS CAMPOS PARA TRAZABILIDAD
  frontendCreatedAt DateTime? // Timestamp exacto cuando se cre贸 la venta en el frontend
  wasOffline        Boolean   @default(false) // Si la venta se cre贸 sin conexi贸n
  syncAttempts      Int       @default(0) // Contador de intentos de sincronizaci贸n

  // Relaci贸n con descuentos aplicados
  appliedDiscounts AppliedDiscount[]
}

// Tabla intermedia para manejar la relaci贸n muchos a muchos entre Venta y ProductoTienda.
model VentaProducto {
  id               String         @id @default(uuid())
  venta            Venta          @relation(fields: [ventaId], references: [id], onDelete: Cascade) // Venta asociada
  ventaId          String
  producto         ProductoTienda @relation(fields: [productoTiendaId], references: [id]) // Producto vendido
  productoTiendaId String
  cantidad         Float // Cantidad de productos vendidos en la transacci贸n (soporta decimales)
  costo            Float          @default(0) // Costo al momento de la venta
  precio           Float          @default(0) // Precio al momento de la venta
}

// Representa un per铆odo de ventas cerrado con una fecha de inicio y una fecha de cierre.
model CierrePeriodo {
  id          String    @id @default(uuid())
  fechaInicio DateTime
  fechaFin    DateTime?
  tienda      Tienda    @relation(fields: [tiendaId], references: [id])
  tiendaId    String
  ventas      Venta[]

  // Campos denormalizados para resumen
  totalVentas        Float @default(0)
  totalGanancia      Float @default(0)
  totalInversion     Float @default(0)
  totalTransferencia Float @default(0)

  // Nuevos campos para consignaci贸n
  totalVentasPropias         Float @default(0)
  totalVentasConsignacion    Float @default(0)
  totalGananciasPropias      Float @default(0)
  totalGananciasConsignacion Float @default(0)

  prodProveedoresLiquidacion ProductoProveedorLiquidacion[]

  // Idices
  @@index([fechaInicio])
  @@index([fechaFin])
  @@index([tiendaId])
}

model MovimientoStock {
  id               String         @id @default(uuid())
  productoTienda   ProductoTienda @relation(fields: [productoTiendaId], references: [id])
  productoTiendaId String

  tipo         MovimientoTipo // "ENTRADA" | "SALIDA" | "AJUSTE" | "VENTA"
  cantidad     Float // Positiva para entradas, negativa para salidas (soporta decimales)
  motivo       String? // Texto libre o tipos definidos (ajuste manual, error, etc.)
  referenciaId String? // Puede guardar el ID de una Venta, Entrada o Ajuste
  fecha        DateTime       @default(now())

  // Existencia del producto ANTES de aplicar este movimiento
  existenciaAnterior Float? // Null para movimientos existentes, valor para nuevos movimientos

  //  CAMPOS PARA CPP
  costoUnitario Float? // Costo unitario de la compra (solo para COMPRA)
  costoTotal    Float? // Costo total de la compra (cantidad * costoUnitario)
  costoAnterior Float? // Costo promedio ANTES de este movimiento
  costoNuevo    Float? // Costo promedio DESPUS de este movimiento (CPP calculado)

  usuario   Usuario? @relation(fields: [usuarioId], references: [id])
  usuarioId String?

  tienda   Tienda @relation("MovimientoStockOrigen", fields: [tiendaId], references: [id])
  tiendaId String

  // Proveedor para movimientos de consignaci贸n
  proveedor   Proveedor? @relation(fields: [proveedorId], references: [id])
  proveedorId String?

  destination   Tienda? @relation("MovimientoStockDestino", fields: [destinationId], references: [id])
  destinationId String?

  state MovimientoState @default(APROBADO)

  @@index([productoTiendaId])
  @@index([fecha])
}

// =====================
// П DESCUENTOS (MVP)
// =====================

enum DiscountType {
  PERCENTAGE
  FIXED
  PROMO_CODE
}

enum DiscountAppliesTo {
  TICKET
  PRODUCT
  CATEGORY
  CUSTOMER
}

model DiscountRule {
  id         String            @id @default(uuid())
  name       String
  type       DiscountType
  value      Float // Porcentaje (0-100) o monto fijo, seg煤n type
  appliesTo  DiscountAppliesTo // mbito de aplicaci贸n
  conditions Json? // JSON con condiciones: { minTotal, productIds, categoryIds, customerIds, code }
  startDate  DateTime?
  endDate    DateTime?
  isActive   Boolean           @default(true)

  // Contexto de negocio y auditor铆a
  createdAt DateTime @default(now())
  createdBy String?
  negocio   Negocio? @relation(fields: [negocioId], references: [id])
  negocioId String?

  applied AppliedDiscount[]

  @@index([isActive])
  @@index([startDate])
  @@index([endDate])
}

model AppliedDiscount {
  id               String       @id @default(uuid())
  discountRule     DiscountRule @relation(fields: [discountRuleId], references: [id])
  discountRuleId   String
  venta            Venta        @relation(fields: [ventaId], references: [id], onDelete: Cascade)
  ventaId          String
  amount           Float // Monto real descontado
  productsAffected Json? // Lista de productos afectados si aplica
  createdAt        DateTime     @default(now())

  @@index([ventaId])
  @@index([discountRuleId])
}

// Representa un proveedor del negocio
model Proveedor {
  id          String   @id @default(uuid())
  nombre      String // Nombre del proveedor (obligatorio)
  descripcion String? // Descripci贸n del proveedor (opcional)
  direccion   String? // Direcci贸n del proveedor (opcional)
  telefono    String? // Tel茅fono del proveedor (opcional)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  negocio   Negocio @relation(fields: [negocioId], references: [id])
  negocioId String

  //  Relaci贸n opcional con Usuario
  usuario   Usuario? @relation("ProveedorUsuario", fields: [usuarioId], references: [id])
  usuarioId String?

  // Relaci贸n con movimientos de consignaci贸n
  movimientos MovimientoStock[]

  // Relaci贸n con productos en consignaci贸n
  productosConsignacion ProductoTienda[]

  prodProveedorLiquidacion ProductoProveedorLiquidacion[]

  // ndice de unicidad compuesto: nombre 煤nico por negocio
  @@unique([nombre, negocioId])
  @@index([nombre])
}

// Representa los destinos de transferencia para cada tienda
model TransferDestinations {
  id          String  @id @default(uuid())
  nombre      String // Nombre del destino de transferencia
  descripcion String? // Descripci贸n del destino (opcional)
  default     Boolean @default(false) // Indica si es el destino por defecto
  tienda      Tienda  @relation(fields: [tiendaId], references: [id])
  tiendaId    String

  // Relaci贸n con las ventas que usan este destino
  ventas Venta[]

  // ndice de unicidad compuesto: nombre 煤nico por tienda
  @@unique([nombre, tiendaId])
  @@index([tiendaId])
}

model ProductoProveedorLiquidacion {
  id         String @id @default(uuid())
  monto      Float  @default(0)
  vendidos   Float  @default(0)
  costo      Float  @default(0)
  precio     Float  @default(0)
  existencia Float  @default(0)

  createdAt    DateTime  @default(now())
  liquidatedAt DateTime?

  cierre   CierrePeriodo @relation(fields: [cierreId], references: [id])
  cierreId String

  proveedor   Proveedor @relation(fields: [proveedorId], references: [id])
  proveedorId String

  producto   Producto @relation(fields: [productoId], references: [id])
  productoId String

  @@unique([cierreId, proveedorId, productoId])
}

enum MovimientoTipo {
  COMPRA
  VENTA
  TRASPASO_ENTRADA
  TRASPASO_SALIDA
  AJUSTE_SALIDA
  AJUSTE_ENTRADA
  DESAGREGACION_BAJA
  DESAGREGACION_ALTA
  CONSIGNACION_ENTRADA
  CONSIGNACION_DEVOLUCION
}

// Modelo para las notificaciones del sistema
model Notificacion {
  id               String           @id @default(uuid())
  titulo           String
  descripcion      String
  fechaInicio      DateTime
  fechaFin         DateTime
  nivelImportancia NivelImportancia @default(MEDIA)
  tipo             TipoNotificacion
  leidoPor         String           @default("") // Array de userIds separados por coma
  negociosDestino  String           @default("") // Array de negocioIds separados por coma (vac铆o = todos)
  usuariosDestino  String           @default("") // Array de userIds separados por coma (vac铆o = todos)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  @@index([fechaInicio])
  @@index([fechaFin])
  @@index([tipo])
  @@index([nivelImportancia])
}

enum NivelImportancia {
  BAJA
  MEDIA
  ALTA
  CRITICA
}

enum TipoNotificacion {
  ALERTA
  NOTIFICACION
  PROMOCION
  MENSAJE
}

enum MovimientoState {
  PENDIENTE
  APROBADO
}
